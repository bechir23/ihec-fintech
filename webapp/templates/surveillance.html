{% extends "base.html" %}
{% block title %}Surveillance — BVMT{% endblock %}
{% block content %}
<div class="page-header">
    <h4 class="mb-1"><i class="bi bi-shield-exclamation me-2 text-orange"></i>Surveillance du Marché</h4>
    <small class="text-secondary">Détection d'anomalies, alertes en temps réel et patterns suspects — Use case CMF</small>
</div>

<div id="loading" class="text-center py-5"><div class="spinner-border" style="width:3rem;height:3rem"></div><p class="mt-3 text-secondary">Scan du marché en cours...</p></div>

<div id="content" class="d-none fade-in">
    <!-- Summary KPIs -->
    <div class="row g-3 mb-4">
        <div class="col-6 col-md-3"><div class="stat-card"><div class="stat-label">Total Alertes</div><div class="stat-value fs-4 text-orange" id="totalAlerts">—</div></div></div>
        <div class="col-6 col-md-3"><div class="stat-card glow-red"><div class="stat-label"><i class="bi bi-exclamation-triangle text-red"></i> Critiques</div><div class="stat-value fs-4 text-red" id="highAlerts">—</div></div></div>
        <div class="col-6 col-md-3"><div class="stat-card"><div class="stat-label"><i class="bi bi-exclamation-circle text-orange"></i> Moyennes</div><div class="stat-value fs-4 text-orange" id="medAlerts">—</div></div></div>
        <div class="col-6 col-md-3"><div class="stat-card"><div class="stat-label"><i class="bi bi-info-circle text-accent"></i> Faibles</div><div class="stat-value fs-4 text-accent" id="lowAlerts">—</div></div></div>
    </div>

    <!-- Alert Type Distribution -->
    <div class="row g-3 mb-4">
        <div class="col-md-4">
            <div class="card h-100">
                <div class="card-header"><i class="bi bi-pie-chart me-2"></i>Distribution par Type</div>
                <div class="card-body"><canvas id="typeChart" height="250"></canvas></div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card h-100">
                <div class="card-header"><i class="bi bi-bar-chart me-2"></i>Par Sévérité</div>
                <div class="card-body"><canvas id="sevChart" height="250"></canvas></div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card h-100">
                <div class="card-header"><i class="bi bi-search me-2"></i>Investiguer un Titre</div>
                <div class="card-body">
                    <select class="form-select bg-dark text-light border-secondary mb-3" id="investStock">
                        <option value="">Sélectionner...</option>
                    </select>
                    <button class="btn btn-accent w-100 mb-3" onclick="investigateStock()"><i class="bi bi-search me-1"></i>Scanner</button>
                    <div id="investResult"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Alerts Table -->
    <div class="card mb-4">
        <div class="card-header d-flex justify-content-between">
            <span><i class="bi bi-bell me-2"></i>Alertes Détectées</span>
            <div>
                <select class="form-select form-select-sm bg-dark text-light border-secondary d-inline-block" style="width:auto" id="filterSeverity" onchange="filterAlerts()">
                    <option value="all">Toutes</option>
                    <option value="high">Critiques</option>
                    <option value="medium">Moyennes</option>
                    <option value="low">Faibles</option>
                </select>
            </div>
        </div>
        <div class="card-body p-0" style="max-height:500px;overflow-y:auto">
            <table class="table table-hover table-sm mb-0">
                <thead><tr><th>Sévérité</th><th>Titre</th><th>Type</th><th>Description</th><th>Date</th><th></th></tr></thead>
                <tbody id="alertsTable"></tbody>
            </table>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
let allAlerts = [];

async function loadAlerts() {
    try {
        const [alertsRes, stocksRes] = await Promise.all([
            fetch('/api/anomalies').then(r=>r.json()),
            fetch('/api/stocks').then(r=>r.json())
        ]);

        if (!alertsRes.success) throw new Error(alertsRes.error);
        allAlerts = alertsRes.alerts || [];

        // Populate stock selector
        if (stocksRes.success) {
            document.getElementById('investStock').innerHTML = '<option value="">Sélectionner...</option>' +
                stocksRes.stocks.slice(0,50).map(s => `<option value="${s.code}">${s.stock} (${s.code})</option>`).join('');
        }

        // KPIs
        document.getElementById('totalAlerts').textContent = allAlerts.length;
        document.getElementById('highAlerts').textContent = allAlerts.filter(a=>a.severity==='high').length;
        document.getElementById('medAlerts').textContent = allAlerts.filter(a=>a.severity==='medium').length;
        document.getElementById('lowAlerts').textContent = allAlerts.filter(a=>!a.severity||a.severity==='low').length;

        // Type distribution chart
        const types = {};
        allAlerts.forEach(a => { types[a.type] = (types[a.type]||0)+1; });
        new Chart('typeChart', {
            type: 'doughnut',
            data: {
                labels: Object.keys(types),
                datasets: [{ data: Object.values(types), backgroundColor: ['#58a6ff','#f85149','#d29922','#3fb950','#bc8cff','#39d4e0'], borderWidth: 0 }]
            },
            options: { responsive:true, plugins:{legend:{position:'bottom', labels:{color:'#8b949e', font:{size:10}}}} }
        });

        // Severity chart
        new Chart('sevChart', {
            type: 'bar',
            data: {
                labels: ['Critique', 'Moyen', 'Faible'],
                datasets: [{ data: [
                    allAlerts.filter(a=>a.severity==='high').length,
                    allAlerts.filter(a=>a.severity==='medium').length,
                    allAlerts.filter(a=>!a.severity||a.severity==='low').length
                ], backgroundColor: ['#f85149','#d29922','#58a6ff'] }]
            },
            options: { responsive:true, indexAxis:'y', plugins:{legend:{display:false}}, scales:{x:{ticks:{color:'#8b949e'},grid:{color:'rgba(48,54,61,0.3)'}},y:{ticks:{color:'#8b949e'}}} }
        });

        renderAlerts(allAlerts);
        document.getElementById('loading').classList.add('d-none');
        document.getElementById('content').classList.remove('d-none');
    } catch(e) {
        document.getElementById('loading').innerHTML = `<div class="alert alert-danger">${e.message}</div>`;
    }
}

function renderAlerts(alerts) {
    document.getElementById('alertsTable').innerHTML = alerts.map(a => {
        const sev = a.severity || 'low';
        const sevBadge = sev==='high' ? 'badge-red' : sev==='medium' ? 'badge-orange' : 'badge-accent';
        const sevLabel = sev==='high' ? 'CRITIQUE' : sev==='medium' ? 'MOYEN' : 'FAIBLE';
        return `<tr>
            <td><span class="badge ${sevBadge}">${sevLabel}</span></td>
            <td><strong>${a.stock||a.stock_code||'—'}</strong></td>
            <td>${a.type||'—'}</td>
            <td class="small">${a.description||a.message||'—'}</td>
            <td class="text-secondary small">${a.date||'—'}</td>
            <td>${a.stock_code ? `<a href="/stock/${a.stock_code}" class="btn btn-sm btn-outline-accent py-0">Voir</a>` : ''}</td>
        </tr>`;
    }).join('');
}

function filterAlerts() {
    const sev = document.getElementById('filterSeverity').value;
    renderAlerts(sev === 'all' ? allAlerts : allAlerts.filter(a => (a.severity||'low') === sev));
}

async function investigateStock() {
    const code = document.getElementById('investStock').value;
    if (!code) return;
    document.getElementById('investResult').innerHTML = '<div class="spinner-border spinner-border-sm"></div>';

    try {
        const res = await fetch(`/api/anomalies/${code}`);
        const d = await res.json();
        if (d.success) {
            const alerts = d.alerts || [];
            document.getElementById('investResult').innerHTML = `
                <div class="alert ${alerts.length ? 'alert-warning' : 'alert-success'} py-2">
                    <strong>${alerts.length} anomalie(s)</strong> détectée(s)
                </div>
                ${alerts.slice(0,5).map(a => `<div class="small mb-1"><span class="badge ${a.severity==='high'?'badge-red':'badge-orange'} me-1">${a.severity}</span>${a.description||a.type}</div>`).join('')}
                <a href="/stock/${code}" class="btn btn-sm btn-outline-accent mt-2 w-100">Détails complets</a>
            `;
        }
    } catch(e) {
        document.getElementById('investResult').innerHTML = `<div class="alert alert-danger py-2">${e.message}</div>`;
    }
}

loadAlerts();
</script>
{% endblock %}
